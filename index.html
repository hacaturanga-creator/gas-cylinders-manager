<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление баллонами газов</title>
    <style>
        /* Все стили остаются без изменений */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); color: #333; min-height: 100vh; }
        .hidden { display: none !important; }
        
        /* ... остальные стили ... */
    </style>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2>Вход в систему</h2>
            <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                Для тестирования используйте:<br>
                Email: admin@example.com<br>
                Пароль: admin123
            </p>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="loginEmail" placeholder="admin@example.com" value="admin@example.com">
            </div>
            <div class="form-group">
                <label>Пароль:</label>
                <input type="password" id="loginPassword" placeholder="Пароль" value="admin123">
            </div>
            <button id="loginBtn" class="btn btn-primary btn-block">Войти</button>
            <button id="registerBtn" class="btn btn-secondary btn-block">Зарегистрировать нового пользователя</button>
            <button id="initAdminBtn" class="btn btn-warning btn-block">Инициализировать тестового администратора</button>
            <div id="loginError" class="error-message hidden"></div>
        </div>
    </div>

    <!-- ... остальные модальные окна без изменений ... -->

    <div id="app" class="hidden">
        <!-- ... остальной интерфейс без изменений ... -->
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA0Guq1AuGZ1HnlQUeoEgrdC8peHc1Qkms",
            authDomain: "gas-cylinders-manager.firebaseapp.com",
            projectId: "gas-cylinders-manager",
            storageBucket: "gas-cylinders-manager.firebasestorage.app",
            messagingSenderId: "499434221546",
            appId: "1:499434221546:web:a2a37371ca297b316bcc93"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Объект приложения
        const App = {
            currentUser: null,
            userRole: 'user',
            storage: [],
            cylinders: [],
            archivedCylinders: [],
            draggingCylinder: null,
            dragSource: null,
            selectedExportFormat: 'excel',
            realtimeListeners: [],
            activeUsers: 1,
            lastUpdateTime: null,
            realtimeIndicator: null,
            cylinderToArchive: null,
            storageToEdit: null,
            editingCylinderId: null,

            async init() {
                console.log('Инициализация приложения...');
                
                // Устанавливаем даты по умолчанию
                const today = new Date().toISOString().split('T')[0];
                const nextYear = new Date();
                nextYear.setFullYear(nextYear.getFullYear() + 1);
                const nextYearStr = nextYear.toISOString().split('T')[0];
                
                document.getElementById('deliveryDate').value = today;
                document.getElementById('manufactureDate').value = today;
                document.getElementById('nextInspectionDate').value = nextYearStr;
                document.getElementById('exportDate').value = today;
                
                // Создаем индикатор реального времени
                this.createRealtimeIndicator();
                
                // Проверяем, есть ли тестовый администратор
                await this.checkAndCreateTestAdmin();
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        this.currentUser = user;
                        await this.loadUserRole();
                        this.showApp();
                        
                        await this.setUserActive(true);
                        this.setupRealtimeListeners();
                        
                    } else {
                        this.showLogin();
                        this.stopRealtimeListeners();
                    }
                });

                this.setupEventListeners();
            },

            async checkAndCreateTestAdmin() {
                try {
                    // Проверяем, есть ли уже пользователи
                    const usersSnapshot = await db.collection('users').limit(1).get();
                    
                    if (usersSnapshot.empty) {
                        console.log('Нет пользователей. Можно создать тестового администратора.');
                        // Показываем кнопку инициализации
                        document.getElementById('initAdminBtn').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Ошибка проверки пользователей:', error);
                }
            },

            async initializeTestAdmin() {
                const email = 'admin@example.com';
                const password = 'admin123';
                
                try {
                    // Создаем пользователя в Firebase Auth
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    
                    // Создаем запись в Firestore с ролью admin
                    await db.collection('users').doc(userCredential.user.uid).set({
                        email: email,
                        role: 'admin',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        name: 'Тестовый администратор',
                        isTestAdmin: true
                    });
                    
                    this.showNotification('Тестовый администратор создан! Теперь вы можете войти.', 'success');
                    
                    // Скрываем кнопку инициализации
                    document.getElementById('initAdminBtn').classList.add('hidden');
                    
                } catch (error) {
                    console.error('Ошибка создания тестового администратора:', error);
                    
                    if (error.code === 'auth/email-already-in-use') {
                        // Пользователь уже существует, обновляем роль
                        try {
                            // Входим как существующий пользователь
                            const userCredential = await auth.signInWithEmailAndPassword(email, password);
                            
                            // Обновляем роль в Firestore
                            await db.collection('users').doc(userCredential.user.uid).update({
                                role: 'admin',
                                isTestAdmin: true
                            });
                            
                            this.showNotification('Роль обновлена на администратор!', 'success');
                            document.getElementById('initAdminBtn').classList.add('hidden');
                            
                        } catch (loginError) {
                            this.showError('loginError', 'Не удалось обновить роль. Попробуйте позже.');
                        }
                    } else {
                        this.showError('loginError', error.message);
                    }
                }
            },

            async loadUserRole() {
                try {
                    const userDoc = await db.collection('users').doc(this.currentUser.uid).get();
                    if (userDoc.exists) {
                        this.userRole = userDoc.data().role || 'user';
                    } else {
                        // Если запись не существует, создаем ее
                        const role = this.currentUser.email.toLowerCase().includes('admin') ? 'admin' : 'user';
                        await db.collection('users').doc(this.currentUser.uid).set({
                            email: this.currentUser.email,
                            role: role,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        this.userRole = role;
                    }
                    
                    this.updateUIForRole();
                    
                } catch (error) {
                    console.error('Ошибка загрузки роли:', error);
                    this.userRole = 'user';
                }
            },

            updateUIForRole() {
                const userRoleElement = document.getElementById('userRole');
                const adminSection = document.getElementById('adminSection');
                const adminButtons = document.querySelectorAll('.admin-only');
                
                userRoleElement.textContent = this.userRole === 'admin' ? 'Администратор' : 'Пользователь';
                userRoleElement.style.background = this.userRole === 'admin' ? '#e74c3c' : '#3498db';
                
                if (this.userRole === 'admin') {
                    adminSection.classList.remove('hidden');
                    adminButtons.forEach(btn => btn.classList.add('show'));
                } else {
                    adminSection.classList.add('hidden');
                    adminButtons.forEach(btn => btn.classList.remove('show'));
                }
            },

            createRealtimeIndicator() {
                this.realtimeIndicator = document.createElement('div');
                this.realtimeIndicator.className = 'realtime-indicator';
                this.realtimeIndicator.innerHTML = `
                    <div class="pulse"></div>
                    <span>Реальное время</span>
                `;
                document.body.appendChild(this.realtimeIndicator);
                
                setInterval(() => {
                    this.updateRealtimeIndicator();
                }, 1000);
            },

            updateRealtimeIndicator() {
                if (this.lastUpdateTime) {
                    const diff = Date.now() - this.lastUpdateTime;
                    const seconds = Math.floor(diff / 1000);
                    
                    if (seconds < 10) {
                        this.realtimeIndicator.classList.remove('offline');
                        this.realtimeIndicator.innerHTML = `
                            <div class="pulse"></div>
                            <span>Активно (${this.activeUsers} онлайн)</span>
                        `;
                    } else if (seconds < 30) {
                        this.realtimeIndicator.classList.remove('offline');
                        this.realtimeIndicator.innerHTML = `
                            <div class="pulse"></div>
                            <span>Обновлено ${seconds} сек назад</span>
                        `;
                    } else {
                        this.realtimeIndicator.classList.add('offline');
                        this.realtimeIndicator.innerHTML = `
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: white;"></div>
                            <span>Оффлайн (${seconds} сек)</span>
                        `;
                    }
                }
            },

            async setUserActive(isActive) {
                if (!this.currentUser) return;
                
                try {
                    const userRef = db.collection('activeUsers').doc(this.currentUser.uid);
                    
                    if (isActive) {
                        await userRef.set({
                            email: this.currentUser.email,
                            role: this.userRole,
                            lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                            status: 'online'
                        });
                    } else {
                        await userRef.delete();
                    }
                } catch (error) {
                    console.error('Ошибка обновления статуса пользователя:', error);
                }
            },

            setupRealtimeListeners() {
                console.log('Настройка слушателей реального времени...');
                
                this.stopRealtimeListeners();
                
                // Слушатель для хранилищ
                const storageListener = db.collection('storage')
                    .onSnapshot((snapshot) => {
                        console.log('Хранилища обновлены в реальном времени');
                        this.lastUpdateTime = Date.now();
                        this.storage = [];
                        snapshot.forEach(doc => {
                            this.storage.push({ id: doc.id, ...doc.data() });
                        });
                        this.renderWorkspace();
                        this.updateStats();
                    }, (error) => {
                        console.error('Ошибка слушателя хранилищ:', error);
                    });
                
                this.realtimeListeners.push(storageListener);
                
                // Слушатель для баллонов
                const cylindersListener = db.collection('cylinders')
                    .where('archived', '==', false)
                    .onSnapshot((snapshot) => {
                        console.log('Баллоны обновлены в реальном времени');
                        this.lastUpdateTime = Date.now();
                        this.cylinders = [];
                        snapshot.forEach(doc => {
                            this.cylinders.push({ id: doc.id, ...doc.data() });
                        });
                        this.renderWorkspace();
                        this.updateStats();
                    });
                
                this.realtimeListeners.push(cylindersListener);
                
                // Слушатель для архива
                const archiveListener = db.collection('cylinders')
                    .where('archived', '==', true)
                    .onSnapshot((snapshot) => {
                        console.log('Архив обновлен в реальном времени');
                        this.lastUpdateTime = Date.now();
                        this.archivedCylinders = [];
                        snapshot.forEach(doc => {
                            this.archivedCylinders.push({ id: doc.id, ...doc.data() });
                        });
                        this.renderArchive();
                        this.updateStats();
                    });
                
                this.realtimeListeners.push(archiveListener);
                
                // Слушатель для активных пользователей
                const usersListener = db.collection('activeUsers')
                    .onSnapshot((snapshot) => {
                        this.activeUsers = snapshot.size;
                        document.getElementById('activeUsers').textContent = this.activeUsers;
                        this.lastUpdateTime = Date.now();
                    });
                
                this.realtimeListeners.push(usersListener);
                
                // Обновляем статус пользователя каждые 30 секунд
                this.keepAliveInterval = setInterval(() => {
                    if (this.currentUser) {
                        this.setUserActive(true);
                    }
                }, 30000);
            },

            stopRealtimeListeners() {
                this.realtimeListeners.forEach(unsubscribe => {
                    if (typeof unsubscribe === 'function') unsubscribe();
                });
                this.realtimeListeners = [];
                
                if (this.keepAliveInterval) {
                    clearInterval(this.keepAliveInterval);
                }
            },

            setupEventListeners() {
                // Вход
                document.getElementById('loginBtn').addEventListener('click', () => this.login());
                document.getElementById('registerBtn').addEventListener('click', () => this.registerUser());
                document.getElementById('initAdminBtn').addEventListener('click', () => this.initializeTestAdmin());
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                
                // Добавление баллона
                document.getElementById('addCylinderBtn').addEventListener('click', () => this.showAddCylinder());
                document.getElementById('saveCylinderBtn').addEventListener('click', () => this.saveCylinder());
                document.getElementById('cancelCylinderBtn').addEventListener('click', () => this.hideModal('addCylinderModal'));
                
                // Просмотр/редактирование баллона
                document.getElementById('closeViewBtn').addEventListener('click', () => this.hideModal('viewCylinderModal'));
                document.getElementById('editCylinderBtn').addEventListener('click', () => this.editCylinder());
                
                // Архив
                document.getElementById('confirmArchiveBtn').addEventListener('click', () => this.confirmArchive());
                document.getElementById('cancelArchiveBtn').addEventListener('click', () => this.hideModal('archiveCylinderModal'));
                document.getElementById('showArchiveBtn').addEventListener('click', () => this.showArchive());
                
                // Добавление хранилища
                document.getElementById('addStorageBtn').addEventListener('click', () => this.showAddStorage());
                document.getElementById('firstStorageBtn').addEventListener('click', () => this.showAddStorage());
                document.getElementById('saveStorageBtn').addEventListener('click', () => this.saveStorage());
                document.getElementById('cancelStorageBtn').addEventListener('click', () => this.hideModal('addStorageModal'));
                
                // Редактирование хранилища
                document.getElementById('updateStorageBtn').addEventListener('click', () => this.updateStorage());
                document.getElementById('cancelEditStorageBtn').addEventListener('click', () => this.hideModal('editStorageModal'));
                
                // Экспорт
                document.getElementById('exportDataBtn').addEventListener('click', () => this.showExportModal());
                document.getElementById('quickExcelBtn').addEventListener('click', () => this.quickExportExcel());
                document.getElementById('startExportBtn').addEventListener('click', () => this.startExport());
                document.getElementById('cancelExportBtn').addEventListener('click', () => this.hideModal('exportModal'));
                
                // Другие кнопки
                document.getElementById('addDemoDataBtn').addEventListener('click', () => this.addDemoData());
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadData());
                document.getElementById('clearDragBtn').addEventListener('click', () => this.clearDragSelection());
                
                // Обработка закрытия окна/вкладки
                window.addEventListener('beforeunload', () => {
                    this.setUserActive(false);
                    this.stopRealtimeListeners();
                });
            },

            // ========== АУТЕНТИФИКАЦИЯ ==========
            async login() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    this.showError('loginError', 'Введите email и пароль');
                    return;
                }
                
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    this.currentUser = userCredential.user;
                    
                    // Проверяем/создаем запись пользователя
                    const userDoc = await db.collection('users').doc(this.currentUser.uid).get();
                    
                    if (!userDoc.exists) {
                        // Автоматически присваиваем роль admin для удобства тестирования
                        const role = email.toLowerCase().includes('admin') ? 'admin' : 'user';
                        
                        await db.collection('users').doc(this.currentUser.uid).set({
                            email: email,
                            role: role,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        this.userRole = role;
                        this.showNotification(`Создан новый ${role === 'admin' ? 'администратор' : 'пользователь'}`);
                    } else {
                        const userData = userDoc.data();
                        this.userRole = userData.role || 'user';
                    }
                    
                    await this.loadUserRole();
                    this.showApp();
                    
                    await this.setUserActive(true);
                    this.setupRealtimeListeners();
                    
                } catch (error) {
                    console.error('Ошибка входа:', error);
                    
                    if (error.code === 'auth/user-not-found') {
                        const confirmRegister = confirm(`Пользователь "${email}" не найден. Зарегистрировать нового пользователя?`);
                        if (confirmRegister) {
                            await this.registerUser();
                        }
                    } else {
                        this.showError('loginError', error.message);
                    }
                }
            },

            async registerUser() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    this.showError('loginError', 'Введите email и пароль');
                    return;
                }
                
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    this.currentUser = userCredential.user;
                    
                    // Для удобства тестирования: если email содержит "admin" - создаем администратора
                    const role = email.toLowerCase().includes('admin') ? 'admin' : 'user';
                    
                    await db.collection('users').doc(this.currentUser.uid).set({
                        email: email,
                        role: role,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    this.userRole = role;
                    this.showNotification(`Пользователь зарегистрирован как ${role === 'admin' ? 'администратор' : 'пользователь'}!`);
                    
                    await this.loadUserRole();
                    this.showApp();
                    
                    await this.setUserActive(true);
                    this.setupRealtimeListeners();
                    
                } catch (error) {
                    console.error('Ошибка регистрации:', error);
                    
                    if (error.code === 'auth/email-already-in-use') {
                        this.showNotification('Пользователь уже существует. Пробуем войти...', 'info');
                        await this.login();
                    } else {
                        this.showError('loginError', error.message);
                    }
                }
            },

            async logout() {
                await this.setUserActive(false);
                this.stopRealtimeListeners();
                await auth.signOut();
                this.showNotification('Вы вышли из системы', 'info');
            },

            showLogin() {
                document.getElementById('loginModal').classList.remove('hidden');
                document.getElementById('app').classList.add('hidden');
                if (this.realtimeIndicator) {
                    this.realtimeIndicator.style.display = 'none';
                }
            },

            showApp() {
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('currentUser').textContent = `Пользователь: ${this.currentUser.email}`;
                if (this.realtimeIndicator) {
                    this.realtimeIndicator.style.display = 'flex';
                }
                
                // Загружаем данные
                this.loadData();
            },

            // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
            showModal(id) {
                document.getElementById(id).classList.remove('hidden');
                const errorElement = document.getElementById(id + 'Error');
                if (errorElement) errorElement.classList.add('hidden');
            },

            hideModal(id) {
                document.getElementById(id).classList.add('hidden');
            },

            showError(elementId, message) {
                const element = document.getElementById(elementId);
                element.textContent = message;
                element.classList.remove('hidden');
            },

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.remove(), 3000);
            },

            // ========== ОСТАЛЬНЫЕ ФУНКЦИИ (как в предыдущем коде) ==========
            // Все остальные функции остаются без изменений
            // ... (loadData, renderWorkspace, createStorageElement, и т.д.)
            
            // ========== НАЧАЛО РАБОТЫ ==========
            // При загрузке страницы показываем инструкцию
            showWelcomeMessage() {
                const loginContent = document.querySelector('#loginModal .modal-content');
                const welcomeMessage = document.createElement('div');
                welcomeMessage.style.background = '#e8f4f8';
                welcomeMessage.style.padding = '15px';
                welcomeMessage.style.borderRadius = '8px';
                welcomeMessage.style.marginBottom = '15px';
                welcomeMessage.style.fontSize = '14px';
                welcomeMessage.innerHTML = `
                    <h3 style="margin-top: 0; color: #2c3e50;">Добро пожаловать!</h3>
                    <p><strong>Для первого входа:</strong></p>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li>Нажмите "Инициализировать тестового администратора"</li>
                        <li>Или войдите с email <strong>admin@example.com</strong> и паролем <strong>admin123</strong></li>
                        <li>Или зарегистрируйте нового пользователя</li>
                    </ol>
                    <p style="color: #666; font-size: 13px; margin-top: 10px;">
                        Система автоматически создаст тестового администратора при первом запуске.
                    </p>
                `;
                loginContent.insertBefore(welcomeMessage, loginContent.firstChild);
            }
        };

        // Инициализация при загрузке страницы
        window.onload = async () => {
            console.log('Запуск приложения...');
            await App.init();
            App.showWelcomeMessage();
        };

        // Делаем App доступным глобально
        window.App = App;
    </script>
</body>
</html>
